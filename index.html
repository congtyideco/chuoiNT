<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ỨNG DỤNG QUẢN LÝ DANH MỤC THUỐC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: red;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        h2 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            overflow: hidden;
            position: relative;
            min-width: 50px;
            min-height: 30px;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        button {
    background-color:blue; /* Màu đỏ */
    color: white; /* Màu chữ trắng */
    padding: 10px 15px;
    margin: 5px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2); /* Hiệu ứng đổ bóng */
    transition: transform 0.1s, box-shadow 0.1s; /* Hiệu ứng khi hover */
}

button:hover {
    transform: scale(1.05); /* Tăng kích thước khi hover */
    box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3); /* Đổ bóng mạnh hơn khi hover */
}

button:active {
    transform: scale(0.98); /* Thu nhỏ khi nhấn */
    box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2); /* Đổ bóng nhẹ hơn khi nhấn */
}

        .ordered {
            background-color: #90EE90;
        }
        .medicine-ordered {
            background-color: orange;
        }
        .resizer {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 10px;
            height: 10px;
            background: rgba(0, 0, 0, 0.1);
            cursor: se-resize;
            z-index: 1000;
        }
        .column-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            cursor: col-resize;
            z-index: 1000;
        }
        .resizing {
            user-select: none;
        }
        #customerTable th:first-child,
        #customerTable td:first-child {
            width: 50px;
        }
        .guide-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 900px; /* Cố định chiều rộng */
    height: 900px; /* Cố định chiều cao */
    background-color: white;
    border: 1px solid #ccc;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    z-index: 1000;
    overflow: auto; /* Thêm overflow để có thanh cuộn */
}

        .popup-content {
            margin-bottom: 20px;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: #ccc;
            cursor: se-resize;
        }
        #declarationForm {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #declarationForm input {
            flex: 1;
            margin-right: 10px;
        }
        textarea {
            resize: both;
            min-height: 50px;
        }
        
        /* Style cho group header khi sort */
        .group-header {
            background-color: #f0f0f0 !important;
            font-weight: bold;
            padding: 10px !important;
        }
        
        /* Style cho warning popup */
#warningPopup {
    display: none; /* Ẩn mặc định */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff3cd;
    border: 1px solid #ffeeba;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    z-index: 1001;
}


        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #ffeeba;
            padding-bottom: 10px;
        }

        .timer-display {
            background-color: #856404;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>QUẢN LÝ THEO DÕI DANH MỤC THUỐC CHUỖI NHÀ THUỐC</h1>
    
    <h2>Luôn theo sát - đặt mục tiêu trong kỳ chuỗi luôn đặt hàng ít nhất > 70% danh mục họ đã vào</h2>
    <form id="declarationForm">
        <input type="text" id="fullName" placeholder="Họ tên" required>
        <input type="text" id="department" placeholder="Bộ phận" required>
        <input type="date" id="date" required>
    </form>
    <button class="guide-button" onclick="showGuide()">Hướng dẫn</button>
	<button onclick="showVideoPopup()"><i class="fas fa-video"></i> Hướng dẫn video</button>

<div id="videoPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:1000px; height:600px; background:white; box-shadow:0 4px 8px rgba(0,0,0,0.2); border-radius:10px; z-index:1000; overflow:hidden; resize:both;">
    <iframe id="videoFrame" src="https://www.youtube.com/embed/iK-iDa32Bh8" style="width:100%; height:100%; border:none;"></iframe>
    <button onclick="closeVideoPopup()" style="position:absolute; top:10px; right:10px; background:red; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-size:18px;">&times;</button>
</div>
<div id="popupOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;" onclick="closeVideoPopup()"></div>

    <h2>Quản lý danh mục thuốc</h2>
    <button onclick="addNewCustomer()">Thêm mới</button>
    <input type="file" id="fileUpload" accept=".xlsx, .xls">
    <button onclick="uploadExcel()">Upload Excel DSKH</button>
    <button onclick="syncData()">Đồng bộ</button>
	<input type="file" id="updateFileUpload" accept=".xlsx, .xls">
    <button onclick="updateData()">Cập nhật DSKH excel</button>

    <button onclick="saveJSON()">Lưu JSON</button>
    <input type="file" id="jsonFileUpload" accept=".json">
    <button onclick="openJSON()">Mở JSON</button>
    <button onclick="reloadExcel()">Tải lại Excel</button>
    <button onclick="exportExcel()">Xuất Excel</button>
<div style="margin-top: 10px;">
    <label for="appKeyInput" style="font-weight: bold; margin-right: 10px;">Mã ứng dụng:</label>
    <input type="text" id="appKeyInput" placeholder="VD: app1" style="
        width: 150px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    ">
</div>
<button onclick="saveToLocalStorage(document.getElementById('appKeyInput').value)">Lưu dữ liệu</button>
<button onclick="loadFromLocalStorage(document.getElementById('appKeyInput').value)">Tải dữ liệu</button>


    <button onclick="showSortPopup()">Sắp xếp</button>
    <button onclick="exportHTML()">Xuất file HTML quy định</button>
	<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
    <input type="text" id="searchInput" placeholder="Tìm kiếm chung...">
    <button onclick="searchCustomers()">Tìm</button>
    <input type="text" id="staffSearchInput" placeholder="Tên nhân viên phụ trách...">
    <button onclick="searchByStaff()">Tìm theo NV</button>
	<button onclick="hideRows()">Ẩn hàng chọn</button>
<button onclick="unhideRows()">Không ẩn</button>
<button onclick="openStaffSelection()">Chọn nhân viên để ẩn</button>
<button onclick="resetData()" style="background-color: orange; color: white; padding: 10px; margin: 5px; font-weight: bold;">Refresh dữ liệu</button>
<input type="file" id="orderUpdateFile" accept=".xlsx, .xls" style="margin-top: 10px;">
<button onclick="updateOrderData()" style="background-color: blue; color: white; padding: 10px; margin: 5px; font-weight: bold;">Up file đơn hàng trong kỳ</button>



</div>



    <table id="customerTable">
      <thead>
    <tr>
        <th>Chọn</th>
        <th>STT</th>
        <th>Mã sản phẩm</th>
        <th>Tên sản phẩm</th>
        <th>Quy cách</th>
        <th>Gía bán lẻ</th>
        <th>Chiết khấu</th>
        <th>Gía mua vào</th>
        <th>Tên chuỗi NT</th>
        <th>Nhân viên phụ trách</th>
        <th>Đặt hàng non-drugs</th>
        <th>Đặt hàng thuốc</th>
        <th>Báo cáo - ghi chú giao dịch</th>
        <th>Hành động</th>
    </tr>
</thead>

        <tbody></tbody>
    </table>

    <div id="stats"></div>

    <!-- Popup Hướng dẫn -->
    <div id="guidePopup" class="popup">
        <div class="popup-content">
           <h2>Hướng dẫn sử dụng</h2>
			<p style="line-height: 1.8;">
			<strong><u>Bước 1:</u></strong><br>
			Cấp quản lý sẽ quản lý dữ liệu để up lên dứng dụng này từ việc chọn kỳ tứ ngày 1-1-2023 đến này, xuất file excel từ ERP-DANH SÁCH KHÁCH KHÁNG.<br>
			Sau đó, file excel này sẽ được bỏ các tiêu đề phụ chỉ chừa lại dữ liệu theo cấu trúc khung của ứng dụng này gồm:<br>
			*STT	MÃ	- Khách hàng -	Người liên hệ	Điện thoại	- Email	Khu vực	 - Địa chỉ -	Nhân viên phụ trách <br>
			*Sau đó, có thể nhóm theo ứng đối tượng : Nhà Thuốc - công ty dược- chuỗi - bán lẻ -ctv ; hay nhóm theo khu vực khách hàng điều được<br>
			*( Chú ý loại bổ khách hàng không hợp tác- chuỗi NT lời lớn ra)<br>
			* Up file đã sắp xếp lên ứng dụng ERP quản lý khách hàng này- chọn đồng bộ để file load lên hết - sau đó bấm lưu file json lại để Lưu<br>
			* File này là file đối chứng định kỳ cuối thàng cập nhật 1 lần lại- cách cập nhật là chỉ cần thêm mã khách hàng tên , địa chỉ- khu vực- nhân viên phụ trách;
			sau đó bấm lưu<br>
			<strong><u>Bước 2: </u></strong><br>
			*Phân bổ tên nhân phụ trách vào - lúc này tùy theo bàn bạc BGĐ hay đề xuất , người quản lý sẽ điền tên nhân viên vào khách hàng mà muốn giao<br>
			*Khi điền tên nhân xong, thì nhớ bấm lưu file json để lưu tên họ lại- file này dùng chia sẽ cho BGĐ để xem đồng bộ và để gởi cho nhân viên sau này.<br>
			<strong><u>Bước 3:</u></strong><br>
			Nhân viên mở máy tính vào: khai tên trong form trùng với tên trong dữ liệu thì lúc đó sẽ chạy thống kê số liệu được.<br>
			Để chạy số liệu do máy mình khai báo, thì phải bấm đồng bộ lại một lần nữa. Các em có thể lọc riêng tên của mình phụ trách để theo dõi cho tiện<br>
						
		
            1. Đây là một trong nội dung bắt buột tất cả nhân viên kinh doanh phải quản lý và khai báo thay cho báo cáo cuối kỳ.<br>
			2. Việc thực hiện tốt giúp kiểm soát hiệu quả xúc tiến- chăm sóc khách hàng trong kỳ và tăng doanh thu , tạo tăng trưởng.<br>
			3. Dữ liệu file excel để đồng bộ lên ứng dụng cần quản lý theo dõi trong kỳ, làm căn cứ đánh giá kỳ trước so với ỳ sau.<br>
			<strong>4. Lưu ý: Sau mỗi cuối tháng, em phải xuất ra file excel lưu lại danh sách mới để upload lại cho kỳ đầu tháng tới ( nhớ dùng đúng mẫu file khi đồng bộ).</strong><br>
			<strong> * Ngoài ra có một cách khác: là đầu tháng sau khi khai ngày lập, bạn gở bỏ các chọn màu đặt hàng thàng qua của khách hàng trở về trạng thái trắng hết- sau đó bấm lưu vào máy.</strong><br>
			<strong> * Danh sách khách hàng cuối kỳ chạy từ đơn hàng chọn kỳ đã lập kỳ trước, từ khách hàng đã được công ty giao, từ khách hàng nên thường xuyên cập nhật lại cuối kỳ.<br>
			5. Dữ liệu file excel về khách hàng nên được quản lý, sắp xếp theo từng nhóm đối tượng phụ trách: nhà thuốc, đại lý phân phối, chuỗi NT hay khác.</strong><br>
			6. Đầu tiên chuẩn bị danh sách khách hàng mà công ty đã giao kể cả khách hàng do cá nhân khai thác trong file excel theo form chung trong ứng dụng.<br>
			8. Mở file từ tứng dụng và chọn upload file excel để đồng bộ dự liệu trên ứng dụng để quản lý.<br>
			8. Khi thao tác hay điền thông tin xong nhớ phải bấm lưu file: có 2 dạng lưu fiie: bấm lưu vào máy sẽ lưu dữ liệu trong máy đang làm cố định;<br>
			     <span style="display: inline-block; text-indent: 20px;">- Bấm lưu file có đuổi JSON và cất file vào trong thư mục trên GOOGLE DRIVE ( giống như tủ hồ sơ chung 0, tạo thử mục tên mình, tiêu đề và lưu file.</span><br>
				 <span style="display: inline-block; text-indent: 20px;">- File JSON có thể qua máy khách mở ứng dụng và chọn file lên sẽ mở JSON khi đó nó sẽ đồng bộ dữ liệu đã làm từ máy khác và có thể chỉnh sửa.</span><br>
				 <span style="display: inline-block; text-indent: 20px;">- Lưu khi khi làm xong nhớ bấm lưu file hay lưu file json để bảo lưu dữ liệu cuối kỳ báo cáo.</span><br>
					 
			9. Chức năng xuất file html dùng để thay bảng báo cáo cuối kỳ- file html được gởi trong các kỳ hợp đánh giá nội bộ kinh doanh trong tuần, gởi đến cấp quản lý.<br>
			   việc gởi HTML thay cho báo cáo- nên được lưu tên file tại thời gian lưu và gởi định kỳ đến cấp quản lý và ban giám đốc yêu cầu trong tuần, cuối tháng.<br>
			10. Quản lý khách hàng đặt hàng trong kỳ là thước đo và đánh giá kết quả KPI trong kỳ của mình và tính độ tăng trưởng khách hàng.<br>
			11. Khi phát triển khách hàng mới có đặt hàng trong kỳ, nhân viên nên khai báo trong bảng này sau khi đã khai báo trên ERP 
			   </p>
        </div>
        <span class="close-button" onclick="closeGuide()">&times;</span>
        <div class="resize-handle"></div>
    </div>

    <!-- Popup Sắp xếp -->
    <div id="sortPopup" class="popup">
        <div class="popup-content">
            <h3>Sắp xếp theo</h3>
            <select id="sortField">
                <option value="1">Mã</option>
                <option value="6">Khu vực</option>
                <option value="8">Nhân viên phụ trách</option>
            </select>
            <button onclick="groupAndSortData()">Nhóm và sắp xếp</button>
            <button onclick="closeSortPopup()">Đóng</button>
        </div>
    </div>

    <!-- Warning Popup -->
    <div id="warningPopup">
        <div class="popup-header">
            <h3>Cảnh báo!</h3>
            <div class="timer-display">
                Thời gian hiển thị: <span id="countdown">8</span>s
            </div>
            <span class="close-button">&times;</span>
        </div>
        <div class="popup-content">
            <p>Số khách hàng do em quản lý đặt hàng còn rất thập- hãy tập trung hết mình tương tác<br>
			   chốt đơn họ nhanh hơn- tận dụng mọi hỗ trợ- sản phẩm mới- khơi gợi nhanh để về mục tiêu đặt hàng.<br>
			   Cần nhanh chóng kiểm tra kế hoạch lại- điều phối khách hàng nhanh hơn.<br>
			Kinh nghiệm bí quyết có đơn : đừng chỉ hỏi thăm hàng cũ lúc đầu câu tiếp xúc, mà luôn chuẩn bị một tính huống mới để bắt đầu chia sẽ<br>
			,xem đơn hàng kỳ trước khách hàng ko lấy sản phẩm, hay sản phẩm mới, thì tận dụng để xúc tiếp mở rộng cơ hội chốt sản phẩm mới bên cạnh lên đơn hàng sản><br>
			sản phẩm hiện tại. Em phải chủ đông gợi nhu cầu đặt mục tiêu phải bán được một cách có thển khi đã nói chuyên. <br>
			</p>
        </div>
        <div class="resize-handle"></div>
    </div>
<script>
    // Khai báo biến toàn cục
    let customers = [];
    let currentCustomerCode = 1;

    // Các hàm xử lý khách hàng
    function addNewCustomer() {
        const newCustomer = {
            code: `KH${currentCustomerCode++}`,
            name: '',
            contact: '',
            phone: '',
            email: '',
            area: '',
            address: '',
            staff: '', // Thêm trường nhân viên phụ trách
            ordered: false,
            medicineOrdered: false,
            note: ''
        };
        customers.push(newCustomer);
        renderTable();
    }

    function renderTable() {
        const tbody = document.querySelector('#customerTable tbody');
        tbody.innerHTML = '';
        customers.forEach((customer, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}<div class="resizer"></div><div class="column-resizer"></div></td>
				 <td><input type="checkbox"></td>
                <td><input type="text" value="${customer.code || ''}" onchange="updateCustomer(${index}, 'code', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.name || ''}" onchange="updateCustomer(${index}, 'name', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.contact || ''}" onchange="updateCustomer(${index}, 'contact', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.phone || ''}" onchange="updateCustomer(${index}, 'phone', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.email || ''}" onchange="updateCustomer(${index}, 'email', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.area || ''}" onchange="updateCustomer(${index}, 'area', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.address || ''}" onchange="updateCustomer(${index}, 'address', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="text" value="${customer.staff || ''}" onchange="updateCustomer(${index}, 'staff', this.value)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="checkbox" ${customer.ordered ? 'checked' : ''} onchange="updateCustomer(${index}, 'ordered', this.checked)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><input type="checkbox" ${customer.medicineOrdered ? 'checked' : ''} onchange="updateCustomer(${index}, 'medicineOrdered', this.checked)"><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><textarea onchange="updateCustomer(${index}, 'note', this.value)">${customer.note || ''}</textarea><div class="resizer"></div><div class="column-resizer"></div></td>
                <td><button onclick="deleteCustomer(${index})">Xóa</button><div class="resizer"></div><div class="column-resizer"></div></td>
            `;
            if (customer.ordered) {
                tr.classList.add('ordered');
            }
            if (customer.medicineOrdered) {
                tr.classList.add('medicine-ordered');
            }
            tbody.appendChild(tr);
        });
        updateStats();
        setupResizers();
    }

    function updateCustomer(index, field, value) {
        customers[index][field] = value;
        if (field === 'ordered' || field === 'medicineOrdered') {
            renderTable();
        } else {
            updateStats();
        }
    }

    function deleteCustomer(index) {
        customers.splice(index, 1);
        renderTable();
    }

  function updateStats() {
    const declaredStaff = document.getElementById('fullName').value.trim().toLowerCase();

    if (!declaredStaff) {
        document.getElementById('stats').innerHTML = `
            <span style="color: red">Vui lòng khai báo họ tên để tính toán số liệu</span>
        `;
        return;
    }

    // Lọc khách hàng do nhân viên phụ trách khai báo
    const staffCustomers = customers.filter(c => c.staff.toLowerCase().trim() === declaredStaff);
    const staffTotal = staffCustomers.length;

    // Số khách hàng đã đặt hàng
    const staffOrdered = staffCustomers.filter(c => c.ordered || c.medicineOrdered).length;
    const staffMedicineOrdered = staffCustomers.filter(c => c.medicineOrdered).length;

    // Tỷ lệ đặt hàng
    const staffRate = staffTotal > 0 ? ((staffOrdered / staffTotal) * 100).toFixed(2) : 0;
    const staffMedicineRate = staffTotal > 0 ? ((staffMedicineOrdered / staffTotal) * 100).toFixed(2) : 0;

    // Hiển thị kết quả
    document.getElementById('stats').innerHTML = `
        Tổng số khách hàng của ${declaredStaff}: ${staffTotal}<br>
        Số khách hàng đã đặt hàng: ${staffOrdered}<br>
        Số khách hàng đã đặt hàng thuốc: ${staffMedicineOrdered}<br>
        Tỉ lệ đặt hàng tổng thể: ${staffRate}%<br>
        Tỉ lệ đặt hàng thuốc: ${staffMedicineRate}%
    `;
}



    // Hàm sắp xếp và nhóm dữ liệu mới
    function groupAndSortData() {
        const table = document.querySelector('#customerTable');
        const select = document.getElementById('sortField');
        const columnIndex = parseInt(select.value);
        
        // Clone customers array để không ảnh hưởng đến dữ liệu gốc
        const groupedCustomers = [...customers];
        
        // Sắp xếp và nhóm theo trường đã chọn
        const groups = new Map();
        
        groupedCustomers.forEach(customer => {
            let key = '';
            switch(columnIndex) {
                case 1: key = customer.code || ''; break;
                case 6: key = customer.area || ''; break;
                case 8: key = customer.staff || ''; break;
            }
            
            if (!groups.has(key)) {
                groups.set(key, []);
            }
            groups.get(key).push(customer);
        });
        
        // Sắp xếp các nhóm
        const sortedGroups = new Map([...groups.entries()].sort());
        
        // Cập nhật lại mảng customers theo thứ tự đã sắp xếp
        customers = [];
        sortedGroups.forEach((groupCustomers, groupKey) => {
            customers.push(...groupCustomers);
        });
        
        renderTable();
        closeSortPopup();
    }

    // Các hàm xử lý popup
    function showSortPopup() {
        document.getElementById('sortPopup').style.display = 'block';
    }

    function closeSortPopup() {
        document.getElementById('sortPopup').style.display = 'none';
    }

   function showGuide() {
    document.getElementById('guidePopup').style.display = 'block';
}

function closeGuide() {
    document.getElementById('guidePopup').style.display = 'none';
}
function openStaffSelection() {
    const staffNamesInput = prompt("Nhập danh sách tên nhân viên phụ trách, ngăn cách nhau bằng dấu phẩy:");
    if (staffNamesInput) {
        const staffNames = staffNamesInput.split(',').map(name => name.trim().toLowerCase());
        renderTable(); // Đảm bảo bảng được render trước khi tìm kiếm và chọn
        autoSelectByStaff(staffNames);
    }
}

function autoSelectByStaff(staffNames) {
    const rows = document.querySelectorAll('#customerTable tbody tr');
    
    rows.forEach(row => {
        const staffCell = row.cells[9]; // Cột 'Nhân viên phụ trách' (điều chỉnh lại nếu cần)
        const checkbox = row.querySelector('input[type="checkbox"]');
        
        if (staffCell && checkbox) {
            const staffText = staffCell.querySelector('input[type="text"]').value.trim().toLowerCase();
            if (staffNames.includes(staffText)) {
                checkbox.checked = true; // Tick checkbox nếu tên có trong danh sách
            } else {
                checkbox.checked = false; // Không tick nếu tên không có trong danh sách
            }
        }
    });
}


</script>
<!-- Thêm đoạn script này vào ngay trước </body> -->
<script>
    // Hàm xử lý Excel
   function uploadExcel() {
    const fileInput = document.getElementById('fileUpload');
    const file = fileInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                    raw: false,
                    defval: "",
                    header: ["STT", "MÃ", "Khách hàng", "Người liên hệ", "Điện thoại", "Email", "Khu vực", "Địa chỉ", "Nhân viên phụ trách", "Đã đặt hàng", "Đặt hàng thuốc", "Ghi chú"]
                });

                // Cập nhật danh sách khách hàng
                customers = jsonData.map((row, index) => {
                    return {
                        code: row['MÃ'] || `KH${index + 1}`,
                        name: row['Khách hàng'] || '',
                        contact: row['Người liên hệ'] || '',
                        phone: row['Điện thoại'] || '',
                        email: row['Email'] || '',
                        area: row['Khu vực'] || '',
                        address: row['Địa chỉ'] || '',
                        staff: row['Nhân viên phụ trách'] || '',
                        ordered: row['Đã đặt hàng'] === 'Có',
                        medicineOrdered: row['Đặt hàng thuốc'] === 'Có',
                        note: row['Ghi chú'] || ''
                    };
                });

                // Đảm bảo mã khách hàng là duy nhất
                currentCustomerCode = Math.max(...customers.map(c => parseInt(c.code.replace('KH', '')) || 0)) + 1;

                renderTable();
                alert('Đã tải lên và xử lý file Excel thành công!');
            } catch (error) {
                console.error('Lỗi khi xử lý file Excel:', error);
                alert('Có lỗi xảy ra khi xử lý file Excel. Vui lòng kiểm tra lại.');
            }
        };
        reader.readAsArrayBuffer(file);
    } else {
        alert('Vui lòng chọn một file Excel để tải lên.');
    }
}

function updateData() {
    const fileInput = document.getElementById('updateFileUpload');
    const file = fileInput.files[0];
    
    if (file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                const newData = XLSX.utils.sheet_to_json(worksheet, {
                    raw: false,
                    defval: "",
                    header: ["STT", "MÃ", "Khách hàng", "Người liên hệ", "Điện thoại", "Email", "Khu vực", "Địa chỉ", "Nhân viên phụ trách", "Đã đặt hàng", "Đặt hàng thuốc", "Ghi chú"]
                });

                newData.forEach(row => {
                    const newCustomer = {
                        code: row['MÃ'],
                        name: row['Khách hàng'],
                        contact: row['Người liên hệ'],
                        phone: row['Điện thoại'],
                        email: row['Email'],
                        area: row['Khu vực'],
                        address: row['Địa chỉ'],
                        staff: row['Nhân viên phụ trách'],
                        ordered: row['Đã đặt hàng'] === 'Có',
                        medicineOrdered: row['Đặt hàng thuốc'] === 'Có',
                        note: row['Ghi chú']
                    };

                    // Tìm kiếm bản ghi trùng theo tiêu chí được chỉ định
                    const duplicateIndex = customers.findIndex(customer =>
                        customer.code === newCustomer.code &&
                        customer.name === newCustomer.name &&
                        customer.contact === newCustomer.contact &&
                        customer.phone === newCustomer.phone &&
                        customer.email === newCustomer.email &&
                        customer.area === newCustomer.area &&
                        customer.address === newCustomer.address &&
                        customer.staff === newCustomer.staff
                    );

                    if (duplicateIndex !== -1) {
                        const overwrite = confirm(`Dữ liệu cho khách hàng "${newCustomer.name}" đã tồn tại. Bạn có muốn chép đè lên không?`);

                        if (overwrite) {
                            customers[duplicateIndex] = newCustomer; // Chép đè lên
                        } else {
                            customers.push(newCustomer); // Chép nối tiếp theo
                        }
                    } else {
                        customers.push(newCustomer); // Thêm mới nếu không trùng lặp
                    }
                });

                renderTable();
                alert('Cập nhật dữ liệu thành công!');
            } catch (error) {
                console.error('Lỗi khi xử lý file Excel:', error);
                alert('Có lỗi xảy ra khi cập nhật dữ liệu từ file Excel.');
            }
        };

        reader.readAsArrayBuffer(file);
    } else {
        alert('Vui lòng chọn một file Excel đơn hàng để cập nhật.');
    }
}
function updateOrderData() {
    const fileInput = document.getElementById('orderUpdateFile');
    const file = fileInput.files[0];

    if (!file) {
        alert('Vui lòng chọn một file Excel Đơn Hàng để cập nhật đơn hàng.');
        return;
    }

    const reader = new FileReader();

    reader.onload = function (e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0]; // Lấy tên sheet đầu tiên
            const worksheet = workbook.Sheets[sheetName];

            // Đọc dữ liệu từ file Excel
            const newData = XLSX.utils.sheet_to_json(worksheet, {
                raw: false,
                defval: "",
                header: ["STT", "Mã", "Ngày", "Khách hàng", "Mã số thuế", "Nhân viên", "Số lượng", "Tổng tiền", "Hình thức nợ", "Số tiền nợ", "Hạn thanh toán", "Thu hộ?", "Ký gửi?", "Thuốc?", "Hóa đơn VAT một phần?", "Hóa đơn VAT toàn phần?", "Ghi chú", "Xác nhận?", "Duyệt?", "Ngày hóa đơn", "Ngày Xuất hàng"]
            });

            let updatesCount = 0;

            newData.forEach(row => {
                const customerName = row["Khách hàng"]?.trim();
                const isMedicineOrder = row["Thuốc?"]?.toString().trim().toUpperCase() === "TRUE";

                if (!customerName) {
                    console.warn(`Bỏ qua dòng thiếu dữ liệu: ${JSON.stringify(row)}`);
                    return;
                }

                // Tìm khách hàng trong danh sách ứng dụng
                const customer = customers.find(c =>
                    c.name?.trim().toLowerCase() === customerName.toLowerCase()
                );

                if (customer) {
                    if (isMedicineOrder) {
                        // Tick cột "Đặt hàng thuốc" và bỏ tick cột "Đặt hàng non-drugs"
                        customer.medicineOrdered = true;
                        customer.ordered = false;
                        console.log(`Tick Đặt hàng thuốc cho khách hàng: ${customerName}`);
                    } else {
                        // Tick cột "Đặt hàng non-drugs" và bỏ tick cột "Đặt hàng thuốc"
                        customer.ordered = true;
                        customer.medicineOrdered = false;
                        console.log(`Tick Đặt hàng non-drugs cho khách hàng: ${customerName}`);
                    }
                    updatesCount++;
                } else {
                    console.warn(`Không tìm thấy khách hàng: ${customerName}`);
                }
            });

            // Cập nhật lại giao diện bảng
            renderTable();
            alert(`Cập nhật đơn hàng thành công! Số lượng khách hàng được cập nhật: ${updatesCount}`);
        } catch (error) {
            console.error('Lỗi khi xử lý file Excel:', error);
            alert('Có lỗi xảy ra khi xử lý file Excel. Vui lòng kiểm tra lại.');
        }
    };

    reader.readAsArrayBuffer(file);
}

function exportHTML() {
    const fullName = document.getElementById('fullName').value.trim();
    const department = document.getElementById('department').value.trim();
    const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];

    if (!fullName || !department) {
        alert("Vui lòng khai báo đầy đủ Họ tên và Bộ phận trước khi xuất file.");
        return;
    }

    const fileName = `Baocaotheodoikhachhang-${department}-${date}.html`;

    let dataToExport = `
    <html>
        <head>
            <meta charset="UTF-8">
            <title>Báo cáo theo dõi khách hàng</title>
            <style>
                body { font-family: 'Arial', sans-serif; padding: 20px; background-color: #f9f9f9; color: #333; }
                h1, h2 { text-align: center; color: #007bff; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #007bff; color: white; }
                td { background-color: #f5f5f5; }
                .metadata { margin-bottom: 20px; padding: 10px; background-color: #007bff; color: white; border-radius: 5px; }
                .metadata p { margin: 0; }
            </style>
        </head>
        <body>
            <h1>Báo cáo theo dõi khách hàng</h1>
            <div class="metadata">
                <p><strong>Người lập báo cáo:</strong> ${fullName}</p>
                <p><strong>Bộ phận:</strong> ${department}</p>
                <p><strong>Ngày lập:</strong> ${date}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>MÃ</th>
                        <th>Khách hàng</th>
                        <th>Người liên hệ</th>
                        <th>Điện thoại</th>
                        <th>Email</th>
                        <th>Khu vực</th>
                        <th>Địa chỉ</th>
                        <th>Nhân viên phụ trách</th>
                        <th>Đặt hàng non-drugs</th>
                        <th>Đặt hàng thuốc</th>
                        <th>Ghi chú</th>
                    </tr>
                </thead>
                <tbody>`;

    customers.forEach((customer, index) => {
        dataToExport += `
            <tr>
                <td>${index + 1}</td>
                <td>${customer.code}</td>
                <td>${customer.name}</td>
                <td>${customer.contact}</td>
                <td>${customer.phone}</td>
                <td>${customer.email}</td>
                <td>${customer.area}</td>
                <td>${customer.address}</td>
                <td>${customer.staff}</td>
                <td>${customer.ordered ? "Có" : "Không"}</td>
                <td>${customer.medicineOrdered ? "Có" : "Không"}</td>
                <td>${customer.note}</td>
            </tr>`;
    });

    dataToExport += `
                </tbody>
            </table>
        </body>
    </html>`;

    const blob = new Blob([dataToExport], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert(`Đã xuất file HTML: ${fileName}`);
}



    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(customers.map(c => ({
            STT: c.code,
            MÃ: c.code,
            "Khách hàng": c.name,
            "Người liên hệ": c.contact,
            "Điện thoại": c.phone,
            Email: c.email,
            "Khu vực": c.area,
            "Địa chỉ": c.address,
            "Nhân viên phụ trách": c.staff,
            "Đã đặt hàng": c.ordered ? "TRUE" : "FALSE",
            "Đặt hàng thuốc": c.medicineOrdered ? "TRUE" : "FALSE",
            "Ghi chú": c.note
        })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Customers");

        const fullName = document.getElementById('fullName').value || 'unknown';
        const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
        const fileName = `${fullName}-dulieukh-${date}.xlsx`;

        XLSX.writeFile(wb, fileName);
    }

  function saveJSON() {
    try {
        const fullName = document.getElementById('fullName').value.trim();
        const department = document.getElementById('department').value.trim();
        const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];

        if (!fullName || !department) {
            alert("Vui lòng khai báo đầy đủ Họ tên và Bộ phận trước khi lưu file.");
            return;
        }

        const fileName = `Baocaotheodoikhachhang-${department}-${date}.json`;

        const dataToSave = customers.map(customer => ({
            code: customer.code || '',
            name: customer.name || '',
            contact: customer.contact || '',
            phone: customer.phone || '',
            email: customer.email || '',
            area: customer.area || '',
            address: customer.address || '',
            staff: customer.staff || '',
            ordered: Boolean(customer.ordered),
            medicineOrdered: Boolean(customer.medicineOrdered),
            note: customer.note || ''
        }));

        const jsonString = JSON.stringify(dataToSave, null, 2);
        const blob = new Blob([jsonString], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert(`Đã lưu file JSON: ${fileName}`);
    } catch (error) {
        console.error('Lỗi khi lưu file JSON:', error);
        alert(`Có lỗi xảy ra khi lưu file JSON: ${error.message}`);
    }
}

    function openJSON() {
        const fileInput = document.getElementById('jsonFileUpload');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Vui lòng chọn một file JSON để tải lên.');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const jsonData = JSON.parse(e.target.result);
                customers = jsonData;
                currentCustomerCode = Math.max(...customers.map(c => {
                    const num = parseInt(c.code.replace('KH', ''));
                    return isNaN(num) ? 0 : num;
                })) + 1;
                renderTable();
                alert('Đã tải lên và xử lý file JSON thành công!');
            } catch (error) {
                console.error('Lỗi khi xử lý file JSON:', error);
                alert(`Có lỗi xảy ra khi xử lý file JSON: ${error.message}`);
            }
        };
        reader.readAsText(file);
    }

    // Hàm xử lý resize
    function setupResizers() {
        const table = document.getElementById('customerTable');
        const cols = table.querySelectorAll('th, td');

        cols.forEach(col => {
            const columnResizer = col.querySelector('.column-resizer');
            const cellResizer = col.querySelector('.resizer');

            if (columnResizer) {
                columnResizer.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    const startX = e.pageX;
                    const startWidth = col.offsetWidth;

                    function onMouseMove(e) {
                        const width = startWidth + (e.pageX - startX);
                        col.style.width = `${width}px`;
                    }

                    function onMouseUp() {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            }

            if (cellResizer) {
                cellResizer.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    const startX = e.pageX;
                    const startY = e.pageY;
                    const startWidth = col.offsetWidth;
                    const startHeight = col.offsetHeight;

                    function onMouseMove(e) {
                        const width = startWidth + (e.pageX - startX);
                        const height = startHeight + (e.pageY - startY);
                        col.style.width = `${width}px`;
                        col.style.height = `${height}px`;
                    }

                    function onMouseUp() {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            }
        });
    }

    // Các hàm khác
    function syncData() {
        // Thực hiện đồng bộ dữ liệu
        renderTable();
        alert("Đã đồng bộ dữ liệu.");
    }

    function reloadExcel() {
        // Tải lại dữ liệu Excel
        renderTable();
        alert("Đã tải lại dữ liệu Excel.");
    }

    function saveToLocalStorage(appKey) {
    if (!appKey) {
        alert("Vui lòng nhập mã ứng dụng để lưu dữ liệu.");
        return;
    }
    localStorage.setItem(`data_${appKey}`, JSON.stringify(customers));
    alert(`Dữ liệu đã được lưu cho ứng dụng: ${appKey}`);
}


        function loadFromLocalStorage(appKey) {
    if (!appKey) {
        alert("Vui lòng nhập mã ứng dụng để tải dữ liệu.");
        return;
    }
    const savedData = localStorage.getItem(`data_${appKey}`);
    if (savedData) {
        customers = JSON.parse(savedData);
        renderTable();
        alert(`Dữ liệu đã được tải cho ứng dụng: ${appKey}`);
    } else {
        alert(`Không tìm thấy dữ liệu cho ứng dụng: ${appKey}`);
    }
}


    window.onload = function() {
    const appKey = localStorage.getItem('currentAppKey') || 'default';
    loadFromLocalStorage(appKey);
};


    // Xử lý resize popup
    const popups = document.querySelectorAll('.popup');
    popups.forEach(popup => {
        const resizeHandle = popup.querySelector('.resize-handle');
        if (resizeHandle) {
            resizeHandle.addEventListener('mousedown', initResize, false);
        }
    });

    function initResize(e) {
        const popup = e.target.closest('.popup');
        window.addEventListener('mousemove', resize, false);
        window.addEventListener('mouseup', stopResize, false);

        function resize(e) {
            popup.style.width = (e.clientX - popup.offsetLeft) + 'px';
            popup.style.height = (e.clientY - popup.offsetTop) + 'px';
        }

        function stopResize() {
            window.removeEventListener('mousemove', resize, false);
            window.removeEventListener('mouseup', stopResize, false);
        }
    }
	function searchCustomers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const tbody = document.querySelector('#customerTable tbody');
        
        tbody.innerHTML = ''; // Xóa các hàng cũ

        // Tìm kiếm không phân biệt chữ hoa/thường và hỗ trợ tìm kiếm từ gần đúng
        customers
            .filter(customer => 
                customer.code.toLowerCase().includes(searchTerm) ||
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.area.toLowerCase().includes(searchTerm) ||
                customer.contact.toLowerCase().includes(searchTerm) ||
                customer.staff.toLowerCase().includes(searchTerm) || // Tìm theo nhân viên phụ trách
                (customer.ordered && "đặt hàng".includes(searchTerm)) || 
                (customer.medicineOrdered && "đặt hàng thuốc".includes(searchTerm))
            )
            .forEach((customer, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${customer.code}</td>
                    <td>${customer.name}</td>
                    <td>${customer.contact}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email}</td>
                    <td>${customer.area}</td>
                    <td>${customer.address}</td>
                    <td>${customer.staff}</td>
                    <td>${customer.ordered ? 'Có' : 'Không'}</td>
                    <td>${customer.medicineOrdered ? 'Có' : 'Không'}</td>
                    <td>${customer.note}</td>
                    <td><button onclick="deleteCustomer(${index})">Xóa</button></td>
                `;
                tbody.appendChild(tr);
            });
    }
 // Hàm kiểm tra tỷ lệ đặt hàng cho nhân viên phụ trách
    function kiemTraTiLeDatHang() {
        const nhanVienKhaiBao = document.getElementById('fullName').value.trim().toLowerCase();

        if (!nhanVienKhaiBao) return;  // Thoát nếu chưa khai báo tên nhân viên

        // Lọc khách hàng do nhân viên phụ trách
        const khachHangPhuTrach = customers.filter(c => c.staff.toLowerCase().trim() === nhanVienKhaiBao);
        const tongKhachHang = khachHangPhuTrach.length;
        const khachHangDaDatHang = khachHangPhuTrach.filter(c => c.ordered).length;
        const tiLeDatHang = tongKhachHang > 0 ? (khachHangDaDatHang / tongKhachHang) * 100 : 0;

        // Hiển thị cảnh báo nếu tỷ lệ đặt hàng dưới 50%
        if (tiLeDatHang < 50) {
            hienThongBaoCanhBao(`Tỷ lệ đặt hàng của bạn là ${tiLeDatHang.toFixed(2)}%. Hãy cải thiện ngay!`);
        }
    }

    // Hàm hiển thị cảnh báo với nội dung tùy chỉnh
function hienThongBaoCanhBao(noiDung) {
    const thongBaoPopup = document.getElementById('warningPopup');
    
    // Đặt nội dung cảnh báo
    thongBaoPopup.querySelector('.popup-content').innerHTML = `<p>${noiDung}</p>`;
    thongBaoPopup.style.display = 'block';  // Hiển thị popup
    
    // Tự động ẩn popup sau 6 giây
    setTimeout(() => {
        thongBaoPopup.style.display = 'none';
    }, 6000);
}


    // Khởi động kiểm tra tỷ lệ đặt hàng mỗi 30 giây
    setInterval(kiemTraTiLeDatHang, 30000);

function searchByStaff() {
    const searchTerm = document.getElementById('staffSearchInput').value.toLowerCase().trim();
    const tbody = document.querySelector('#customerTable tbody');
    
    tbody.innerHTML = ''; // Xóa các hàng cũ

    // Lọc khách hàng dựa trên tên nhân viên phụ trách
    customers
        .filter(customer => customer.staff.toLowerCase().includes(searchTerm))
        .forEach((customer, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${customer.code}</td>
                <td>${customer.name}</td>
                <td>${customer.contact}</td>
                <td>${customer.phone}</td>
                <td>${customer.email}</td>
                <td>${customer.area}</td>
                <td>${customer.address}</td>
                <td>${customer.staff}</td>
                <td>${customer.ordered ? 'Có' : 'Không'}</td>
                <td>${customer.medicineOrdered ? 'Có' : 'Không'}</td>
                <td>${customer.note}</td>
                <td><button onclick="deleteCustomer(${index})">Xóa</button></td>
            `;
            tbody.appendChild(tr);
        });
}
let hiddenRows = [];

function hideRows() {
    const rows = document.querySelectorAll('#customerTable tbody tr');
    hiddenRows = []; // Reset hiddenRows để tránh lưu các hàng đã ẩn trước đó

    rows.forEach((row, index) => {
        const checkbox = row.querySelector('input[type="checkbox"]'); 
        if (checkbox && checkbox.checked) {
            hiddenRows.push(index); // Lưu chỉ số hàng ẩn
            row.style.display = 'none'; // Ẩn hàng
        }
    });
}

function unhideRows() {
    const rows = document.querySelectorAll('#customerTable tbody tr');
    hiddenRows.forEach(index => {
        rows[index].style.display = ''; // Hiện lại hàng
    });
    hiddenRows = []; // Reset danh sách các hàng ẩn
}
function resetData() {
    // Bỏ chọn tất cả các checkbox trong dữ liệu hiện tại
    customers.forEach(customer => {
        customer.ordered = false; // Bỏ chọn "Đặt hàng non-drugs"
        customer.medicineOrdered = false; // Bỏ chọn "Đặt hàng thuốc"
    });

    // Cập nhật lại giao diện bảng
    renderTable();
    alert('Tất cả các lựa chọn đã được bỏ chọn!');
}
function showVideoPopup() {
    document.getElementById('videoPopup').style.display = 'block';
    document.getElementById('popupOverlay').style.display = 'block';
}

function closeVideoPopup() {
    document.getElementById('videoPopup').style.display = 'none';
    document.getElementById('popupOverlay').style.display = 'none';
}


</script>
</body>
</html>