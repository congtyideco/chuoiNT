<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ỨNG DỤNG QUẢN LÝ DANH MỤC THUỐC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: red;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        h2 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            overflow: hidden;
            position: relative;
            min-width: 50px;
            min-height: 30px;
        }
        th {
            background-color: #f2f2f2;
            position: relative;
            user-select: none;
        }
        input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        button {
            background-color:blue;
            color: white;
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: scale(0.98);
            box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
        }

        .ordered {
            background-color: #90EE90;
        }
        .medicine-ordered {
            background-color: orange;
        }
        
        /* Resizer styles */
        .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: transparent;
            cursor: col-resize;
            z-index: 1000;
        }
        
        .resizer:hover, .resizer.active {
            background-color: #007acc;
        }
        
        .column-resizing {
            user-select: none;
        }
        
        #customerTable th:first-child,
        #customerTable td:first-child {
            width: 50px;
        }
        .guide-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 900px;
            height: 900px;
            background-color: white;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow: auto;
        }

        .popup-content {
            margin-bottom: 20px;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: #ccc;
            cursor: se-resize;
        }
        #declarationForm {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        #declarationForm input {
            flex: 1;
            margin-right: 10px;
        }
        textarea {
            resize: both;
            min-height: 50px;
        }
        
        /* Style cho group header khi sort */
        .group-header {
            background-color: #f0f0f0 !important;
            font-weight: bold;
            padding: 10px !important;
        }
        
        /* Style cho warning popup */
        #warningPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1001;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #ffeeba;
            padding-bottom: 10px;
        }

        .timer-display {
            background-color: #856404;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
        }
		 /* Nút ERP Home */
        .erp-home-button {
            background-color: #6A0DAD; /* Màu tím đặc trưng cho ERP */
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
  <button class="erp-home-button" onclick="goToERPHome()">ERP Home</button>
    <h1>QUẢN LÝ THEO DÕI DANH MỤC THUỐC CHUỖI NHÀ THUỐC</h1>
    
    <h2>Luôn theo sát - đặt mục tiêu trong kỳ chuỗi luôn đặt hàng ít nhất > 70% danh mục họ đã vào</h2>
    <form id="declarationForm">
        <input type="text" id="fullName" placeholder="Họ tên" required>
        <input type="text" id="department" placeholder="Bộ phận" required>
        <input type="date" id="date" required>
    </form>
    <button class="guide-button" onclick="showGuide()">Hướng dẫn</button>
	<button onclick="showVideoPopup()"><i class="fas fa-video"></i> Hướng dẫn video</button>

<div id="videoPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:1000px; height:600px; background:white; box-shadow:0 4px 8px rgba(0,0,0,0.2); border-radius:10px; z-index:1000; overflow:hidden; resize:both;">
    <iframe id="videoFrame" src="https://www.youtube.com/embed/iK-iDa32Bh8" style="width:100%; height:100%; border:none;"></iframe>
    <button onclick="closeVideoPopup()" style="position:absolute; top:10px; right:10px; background:red; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-size:18px;">&times;</button>
</div>
<div id="popupOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;" onclick="closeVideoPopup()"></div>

    <h2>Quản lý danh mục thuốc</h2>
    <button onclick="addNewCustomer()">Thêm mới</button>
    <input type="file" id="fileUpload" accept=".xlsx, .xls">
    <button onclick="uploadExcel()">Upload Excel DSKH</button>
    <button onclick="syncData()">Đồng bộ</button>
	<input type="file" id="updateFileUpload" accept=".xlsx, .xls">
    <button onclick="updateData()">Cập nhật DSKH excel</button>
   
    <button onclick="reloadExcel()">Tải lại Excel</button>
    <button onclick="exportExcel()">Xuất Excel</button>
<div style="margin-top: 10px;">
    <label for="appKeyInput" style="font-weight: bold; margin-right: 10px;">Mã ứng dụng:</label>
    <input type="text" id="appKeyInput" placeholder="VD: app1" style="
        width: 150px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    ">
</div>
<button onclick="saveToLocalStorage(document.getElementById('appKeyInput').value)">Lưu dữ liệu</button>
<button onclick="loadFromLocalStorage(document.getElementById('appKeyInput').value)">Tải dữ liệu</button>

    <button onclick="showSortPopup()">Sắp xếp</button>
  
	<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
    <input type="text" id="searchInput" placeholder="Tìm kiếm chung...">
    <button onclick="searchCustomers()">Tìm</button>
    <input type="text" id="staffSearchInput" placeholder="Tên nhân viên phụ trách...">
    <button onclick="searchByStaff()">Tìm theo NV</button>
	<button onclick="hideRows()">Ẩn hàng chọn</button>
<button onclick="unhideRows()">Không ẩn</button>
<button onclick="openStaffSelection()">Chọn nhân viên để ẩn</button>
<button onclick="resetData()" style="background-color: orange; color: white; padding: 10px; margin: 5px; font-weight: bold;">Refresh dữ liệu</button>
<input type="file" id="orderUpdateFile" accept=".xlsx, .xls" style="margin-top: 10px;">
<button onclick="updateOrderData()" style="background-color: blue; color: white; padding: 10px; margin: 5px; font-weight: bold;">Up file đơn hàng trong kỳ</button>
</div>

    <table id="customerTable">
      <thead>
    <tr>
        <th>Chọn</th>
        <th>STT</th>
        <th>Mã sản phẩm</th>
        <th>Tên sản phẩm</th>
        <th>Quy cách</th>
        <th>Gía bán lẻ</th>
        <th>Chiết khấu</th>
        <th>Gía mua vào</th>
        <th>Tên chuỗi NT</th>
        <th>Nhân viên phụ trách</th>
        <th>Sản phẩm đã đặt hàng</th>
        <th>Báo cáo - ghi chú giao dịch</th>
        <th>Hành động</th>
    </tr>
</thead>
        <tbody></tbody>
    </table>

    <div id="stats"></div>

    <!-- Popup Hướng dẫn -->
    <div id="guidePopup" class="popup">
        <div class="popup-content">
           <h2>Hướng dẫn sử dụng</h2>
			<p style="line-height: 1.8;">
			<strong><u>Bước 1:</u></strong><br>
			Cấp quản lý sẽ quản lý dữ liệu để up lên dứng dụng này từ việc chọn kỳ tứ ngày 1-1-2023 đến này, xuất file excel từ ERP-DANH SÁCH KHÁCH KHÁNG.<br>
			Sau đó, file excel này sẽ được bỏ các tiêu đề phụ chỉ chừa lại dữ liệu theo cấu trúc khung của ứng dụng này gồm:<br>
			*STT	MÃ	- Khách hàng -	Người liên hệ	Điện thoại	- Email	Khu vực	 - Địa chỉ -	Nhân viên phụ trách <br>
			*Sau đó, có thể nhóm theo ứng đối tượng : Nhà Thuốc - công ty dược- chuỗi - bán lẻ -ctv ; hay nhóm theo khu vực khách hàng điều được<br>
			*( Chú ý loại bổ khách hàng không hợp tác- chuỗi NT lời lớn ra)<br>
			* Up file đã sắp xếp lên ứng dụng ERP quản lý khách hàng này- chọn đồng bộ để file load lên hết - sau đó bấm lưu file json lại để Lưu<br>
			* File này là file đối chứng định kỳ cuối thàng cập nhật 1 lần lại- cách cập nhật là chỉ cần thêm mã khách hàng tên , địa chỉ- khu vực- nhân viên phụ trách;
			sau đó bấm lưu<br>
			<strong><u>Bước 2: </u></strong><br>
			*Phân bổ tên nhân phụ trách vào - lúc này tùy theo bàn bạc BGĐ hay đề xuất , người quản lý sẽ điền tên nhân viên vào khách hàng mà muốn giao<br>
			*Khi điền tên nhân xong, thì nhớ bấm lưu file json để lưu tên họ lại- file này dùng chia sẽ cho BGĐ để xem đồng bộ và để gởi cho nhân viên sau này.<br>
			<strong><u>Bước 3:</u></strong><br>
			Nhân viên mở máy tính vào: khai tên trong form trùng với tên trong dữ liệu thì lúc đó sẽ chạy thống kê số liệu được.<br>
			Để chạy số liệu do máy mình khai báo, thì phải bấm đồng bộ lại một lần nữa. Các em có thể lọc riêng tên của mình phụ trách để theo dõi cho tiện<br>
						
		
            1. Đây là một trong nội dung bắt buột tất cả nhân viên kinh doanh phải quản lý và khai báo thay cho báo cáo cuối kỳ.<br>
			2. Việc thực hiện tốt giúp kiểm soát hiệu quả xúc tiến- chăm sóc khách hàng trong kỳ và tăng doanh thu , tạo tăng trưởng.<br>
			3. Dữ liệu file excel để đồng bộ lên ứng dụng cần quản lý theo dõi trong kỳ, làm căn cứ đánh giá kỳ trước so với ỳ sau.<br>
			<strong>4. Lưu ý: Sau mỗi cuối tháng, em phải xuất ra file excel lưu lại danh sách mới để upload lại cho kỳ đầu tháng tới ( nhớ dùng đúng mẫu file khi đồng bộ).</strong><br>
			<strong> * Ngoài ra có một cách khác: là đầu tháng sau khi khai ngày lập, bạn gở bỏ các chọn màu đặt hàng thàng qua của khách hàng trở về trạng thái trắng hết- sau đó bấm lưu vào máy.</strong><br>
			<strong> * Danh sách khách hàng cuối kỳ chạy từ đơn hàng chọn kỳ đã lập kỳ trước, từ khách hàng đã được công ty giao, từ khách hàng nên thường xuyên cập nhật lại cuối kỳ.<br>
			5. Dữ liệu file excel về khách hàng nên được quản lý, sắp xếp theo từng nhóm đối tượng phụ trách: nhà thuốc, đại lý phân phối, chuỗi NT hay khác.</strong><br>
			6. Đầu tiên chuẩn bị danh sách khách hàng mà công ty đã giao kể cả khách hàng do cá nhân khai thác trong file excel theo form chung trong ứng dụng.<br>
			8. Mở file từ tứng dụng và chọn upload file excel để đồng bộ dự liệu trên ứng dụng để quản lý.<br>
			8. Khi thao tác hay điền thông tin xong nhớ phải bấm lưu file: có 2 dạng lưu fiie: bấm lưu vào máy sẽ lưu dữ liệu trong máy đang làm cố định;<br>
			     <span style="display: inline-block; text-indent: 20px;">- Bấm lưu file có đuổi JSON và cất file vào trong thư mục trên GOOGLE DRIVE ( giống như tủ hồ sơ chung 0, tạo thử mục tên mình, tiêu đề và lưu file.</span><br>
				 <span style="display: inline-block; text-indent: 20px;">- File JSON có thể qua máy khách mở ứng dụng và chọn file lên sẽ mở JSON khi đó nó sẽ đồng bộ dữ liệu đã làm từ máy khác và có thể chỉnh sửa.</span><br>
				 <span style="display: inline-block; text-indent: 20px;">- Lưu khi khi làm xong nhớ bấm lưu file hay lưu file json để bảo lưu dữ liệu cuối kỳ báo cáo.</span><br>
					 
			9. Chức năng xuất file html dùng để thay bảng báo cáo cuối kỳ- file html được gởi trong các kỳ hợp đánh giá nội bộ kinh doanh trong tuần, gởi đến cấp quản lý.<br>
			   việc gởi HTML thay cho báo cáo- nên được lưu tên file tại thời gian lưu và gởi định kỳ đến cấp quản lý và ban giám đốc yêu cầu trong tuần, cuối tháng.<br>
			10. Quản lý khách hàng đặt hàng trong kỳ là thước đo và đánh giá kết quả KPI trong kỳ của mình và tính độ tăng trưởng khách hàng.<br>
			11. Kwhen phát triển khách hàng mới có đặt hàng trong kỳ, nhân viên nên khai báo trong bảng này sau khi đã khai báo trên ERP 
			   </p>
        </div>
        <span class="close-button" onclick="closeGuide()">&times;</span>
        <div class="resize-handle"></div>
    </div>

    <!-- Popup Sắp xếp -->
    <div id="sortPopup" class="popup">
        <div class="popup-content">
            <h3>Sắp xếp theo</h3>
            <select id="sortField">
                <option value="1">Mã</option>
                <option value="6">Khu vực</option>
                <option value="8">Nhân viên phụ trách</option>
            </select>
            <button onclick="groupAndSortData()">Nhóm và sắp xếp</button>
            <button onclick="closeSortPopup()">Đóng</button>
        </div>
    </div>

    <!-- Warning Popup -->
    <div id="warningPopup">
        <div class="popup-header">
            <h3>Cảnh báo!</h3>
            <div class="timer-display">
                Thời gian hiển thị: <span id="countdown">8</span>s
            </div>
            <span class="close-button">&times;</span>
        </div>
        <div class="popup-content">
            <p>Số khách hàng do em quản lý đặt hàng còn rất thập- hãy tập trung hết mình tương tác<br>
			   chốt đơn họ nhanh hơn- tận dụng mọi hỗ trợ- sản phẩm mới- khơi gợi nhanh để về mục tiêu đặt hàng.<br>
			   Cần nhanh chóng kiểm tra kế hoạch lại- điều phối khách hàng nhanh hơn.<br>
			Kinh nghiệm bí quyết có đơn : đừng chỉ hỏi thăm hàng cũ lúc đầu câu tiếp xúc, mà luôn chuẩn bị một tính huống mới để bắt đầu chia sẽ<br>
			,xem đơn hàng kỳ trước khách hàng ko lấy sản phẩm, hay sản phẩm mới, thì tận dụng để xúc tiếp mở rộng cơ hội chốt sản phẩm mới bên cạnh lên đơn hàng sản><br>
			sản phẩm hiện tại. Em phải chủ đông gợi nhu cầu đặt mục tiêu phải bán được một cách có thển khi đã nói chuyên. <br>
			</p>
        </div>
        <div class="resize-handle"></div>
    </div>
<script>
    // Khai báo biến toàn cục
    let customers = [];
    let currentCustomerCode = 1;
    let isResizing = false;
    let currentResizer = null;
    let startX, startWidth;

    // Các hàm xử lý khách hàng
    function addNewCustomer() {
        const newCustomer = {
            code: `SP${currentCustomerCode++}`, // Mã sản phẩm
            name: '', // Tên sản phẩm
            specification: '', // Quy cách
            retailPrice: '', // Giá bán lẻ
            discount: '', // Chiết khấu
            purchasePrice: '', // Giá mua vào
            chainName: '', // Tên chuỗi NT
            staff: '', // Nhân viên phụ trách
            ordered: false, // Sản phẩm đã đặt hàng
            note: '' // Ghi chú
        };
        customers.push(newCustomer);
        renderTable();
    }

    function renderTable() {
        const tbody = document.querySelector('#customerTable tbody');
        tbody.innerHTML = '';
        customers.forEach((customer, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox"></td>
                <td>${index + 1}</td>
                <td><input type="text" value="${customer.code || ''}" onchange="updateCustomer(${index}, 'code', this.value)"></td>
                <td><input type="text" value="${customer.name || ''}" onchange="updateCustomer(${index}, 'name', this.value)"></td>
                <td><input type="text" value="${customer.specification || ''}" onchange="updateCustomer(${index}, 'specification', this.value)"></td>
                <td><input type="text" value="${customer.retailPrice || ''}" onchange="updateCustomer(${index}, 'retailPrice', this.value)"></td>
                <td><input type="text" value="${customer.discount || ''}" onchange="updateCustomer(${index}, 'discount', this.value)"></td>
                <td><input type="text" value="${customer.purchasePrice || ''}" onchange="updateCustomer(${index}, 'purchasePrice', this.value)"></td>
                <td><input type="text" value="${customer.chainName || ''}" onchange="updateCustomer(${index}, 'chainName', this.value)"></td>
                <td><input type="text" value="${customer.staff || ''}" onchange="updateCustomer(${index}, 'staff', this.value)"></td>
                <td><input type="checkbox" ${customer.ordered ? 'checked' : ''} onchange="updateCustomer(${index}, 'ordered', this.checked)"></td>
                <td><textarea onchange="updateCustomer(${index}, 'note', this.value)">${customer.note || ''}</textarea></td>
                <td><button onclick="deleteCustomer(${index})">Xóa</button></td>
            `;
            if (customer.ordered) {
                tr.classList.add('ordered');
            }
            tbody.appendChild(tr);
        });
        updateStats();
        setupColumnResizers();
    }

    function updateCustomer(index, field, value) {
        customers[index][field] = value;
        if (field === 'ordered') {
            renderTable();
        } else {
            updateStats();
        }
    }

    function deleteCustomer(index) {
        customers.splice(index, 1);
        renderTable();
    }

    function updateStats() {
        const declaredStaff = document.getElementById('fullName').value.trim().toLowerCase();

        if (!declaredStaff) {
            document.getElementById('stats').innerHTML = `
                <span style="color: red">Vui lòng khai báo họ tên để tính toán số liệu</span>
            `;
            return;
        }

        // Lọc sản phẩm do nhân viên phụ trách khai báo
        const staffProducts = customers.filter(c => c.staff.toLowerCase().trim() === declaredStaff);
        const staffTotal = staffProducts.length;

        // Số sản phẩm đã đặt hàng
        const staffOrdered = staffProducts.filter(c => c.ordered).length;

        // Tỷ lệ đặt hàng
        const staffRate = staffTotal > 0 ? ((staffOrdered / staffTotal) * 100).toFixed(2) : 0;

        // Hiển thị kết quả
        document.getElementById('stats').innerHTML = `
            Tổng số sản phẩm của ${declaredStaff}: ${staffTotal}<br>
            Số sản phẩm đã đặt hàng: ${staffOrdered}<br>
            Tỉ lệ đặt hàng: ${staffRate}%<br>
        `;
    }

    // Hàm thiết lập resizer cho các cột
    function setupColumnResizers() {
        // Xóa các resizer cũ nếu có
        document.querySelectorAll('.resizer').forEach(el => el.remove());
        
        // Thêm resizer cho mỗi cột trong thead
        const headers = document.querySelectorAll('#customerTable th');
        headers.forEach((header, index) => {
            const resizer = document.createElement('div');
            resizer.classList.add('resizer');
            header.appendChild(resizer);
            
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startResize(e, header, index);
            });
        });
    }

    function startResize(e, header, columnIndex) {
        isResizing = true;
        currentResizer = header;
        startX = e.clientX;
        startWidth = header.offsetWidth;
        
        document.addEventListener('mousemove', resizeColumn);
        document.addEventListener('mouseup', stopResize);
        
        document.body.classList.add('column-resizing');
        header.classList.add('active');
    }

    function resizeColumn(e) {
        if (!isResizing) return;
        
        const width = startWidth + (e.clientX - startX);
        if (width > 50) { // Đảm bảo chiều rộng tối thiểu
            currentResizer.style.width = `${width}px`;
            
            // Áp dụng cùng chiều rộng cho tất cả các ô trong cột
            const columnIndex = Array.from(currentResizer.parentNode.children).indexOf(currentResizer);
            const allRows = document.querySelectorAll('#customerTable tr');
            
            allRows.forEach(row => {
                const cell = row.children[columnIndex];
                if (cell) {
                    cell.style.width = `${width}px`;
                }
            });
        }
    }

    function stopResize() {
        isResizing = false;
        document.removeEventListener('mousemove', resizeColumn);
        document.removeEventListener('mouseup', stopResize);
        
        document.body.classList.remove('column-resizing');
        if (currentResizer) {
            currentResizer.classList.remove('active');
        }
    }

    // Hàm xử lý Excel
    function uploadExcel() {
        const fileInput = document.getElementById('fileUpload');
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: false,
                        defval: "",
                        header: ["STT", "Mã sản phẩm", "Tên sản phẩm", "Quy cách", "Giá bán lẻ", "Chiết khấu", "Giá mua vào", "Tên chuỗi NT", "Nhân viên phụ trách", "Đã đặt hàng", "Ghi chú"]
                    });

                    // Cập nhật danh sách sản phẩm
                    customers = jsonData.map((row, index) => {
                        return {
                            code: row['Mã sản phẩm'] || `SP${index + 1}`,
                            name: row['Tên sản phẩm'] || '',
                            specification: row['Quy cách'] || '',
                            retailPrice: row['Giá bán lẻ'] || '',
                            discount: row['Chiết khấu'] || '',
                            purchasePrice: row['Giá mua vào'] || '',
                            chainName: row['Tên chuỗi NT'] || '',
                            staff: row['Nhân viên phụ trách'] || '',
                            ordered: row['Đã đặt hàng'] === 'Có' || row['Đã đặt hàng'] === 'TRUE',
                            note: row['Ghi chú'] || ''
                        };
                    });

                    // Đảm bảo mã sản phẩm là duy nhất
                    currentCustomerCode = Math.max(...customers.map(c => parseInt(c.code.replace('SP', '')) || 0)) + 1;

                    renderTable();
                    alert('Đã tải lên và xử lý file Excel thành công!');
                } catch (error) {
                    console.error('Lỗi khi xử lý file Excel:', error);
                    alert('Có lỗi xảy ra khi xử lý file Excel. Vui lòng kiểm tra lại.');
                }
            };
            reader.readAsArrayBuffer(file);
        } else {
            alert('Vui lòng chọn một file Excel để tải lên.');
        }
    }

    function updateOrderData() {
        const fileInput = document.getElementById('orderUpdateFile');
        const file = fileInput.files[0];

        if (!file) {
            alert('Vui lòng chọn một file Excel Đơn Hàng để cập nhật đơn hàng.');
            return;
        }

        const reader = new FileReader();

        reader.onload = function (e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                // Đọc dữ liệu từ file Excel đơn hàng
                const orderData = XLSX.utils.sheet_to_json(worksheet, {
                    raw: false,
                    defval: "",
                    header: ["STT", "Mã sản phẩm", "Tên sản phẩm", "Số lượng", "Đơn giá", "Thành tiền", "Ngày đặt", "Tên chuỗi NT", "Ghi chú"]
                });

                let updatesCount = 0;

                orderData.forEach(row => {
                    const productCode = row["Mã sản phẩm"]?.toString().trim();
                    const productName = row["Tên sản phẩm"]?.toString().trim();

                    if (!productCode && !productName) {
                        console.warn(`Bỏ qua dòng thiếu thông tin sản phẩm: ${JSON.stringify(row)}`);
                        return;
                    }

                    // Tìm sản phẩm trong danh sách ứng dụng
                    const productIndex = customers.findIndex(product => 
                        (productCode && product.code?.toString().trim() === productCode) ||
                        (productName && product.name?.toString().trim().toLowerCase() === productName.toLowerCase())
                    );

                    if (productIndex !== -1) {
                        // Tick cột "Sản phẩm đã đặt hàng"
                        customers[productIndex].ordered = true;
                        updatesCount++;
                        console.log(`Tick đặt hàng cho sản phẩm: ${productCode || productName}`);
                    } else {
                        console.warn(`Không tìm thấy sản phẩm: ${productCode || productName}`);
                    }
                });

                // Cập nhật lại giao diện bảng
                renderTable();
                alert(`Cập nhật đơn hàng thành công! Số lượng sản phẩm được cập nhật: ${updatesCount}`);
            } catch (error) {
                console.error('Lỗi khi xử lý file Excel:', error);
                alert('Có lỗi xảy ra khi xử lý file Excel. Vui lòng kiểm tra lại.');
            }
        };

        reader.readAsArrayBuffer(file);
    }
  // Hàm chuyển hướng đến trang chủ ERP
    function goToERPHome() {
        window.location.href = "https://erp-ideco.skyit.vn/#/home/dashboard/main";
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(customers.map(c => ({
            STT: c.code,
            "Mã sản phẩm": c.code,
            "Tên sản phẩm": c.name,
            "Quy cách": c.specification,
            "Giá bán lẻ": c.retailPrice,
            "Chiết khấu": c.discount,
            "Giá mua vào": c.purchasePrice,
            "Tên chuỗi NT": c.chainName,
            "Nhân viên phụ trách": c.staff,
            "Đã đặt hàng": c.ordered ? "Có" : "Không",
            "Ghi chú": c.note
        })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Products");

        const fullName = document.getElementById('fullName').value || 'unknown';
        const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
        const fileName = `${fullName}-dulieusanpham-${date}.xlsx`;

        XLSX.writeFile(wb, fileName);
    }

    // Các hàm khác giữ nguyên
    function syncData() {
        renderTable();
        alert("Đã đồng bộ dữ liệu.");
    }

    function reloadExcel() {
        renderTable();
        alert("Đã tải lại dữ liệu Excel.");
    }

    function saveToLocalStorage(appKey) {
        if (!appKey) {
            alert("Vui lòng nhập mã ứng dụng để lưu dữ liệu.");
            return;
        }
        localStorage.setItem(`data_${appKey}`, JSON.stringify(customers));
        alert(`Dữ liệu đã được lưu cho ứng dụng: ${appKey}`);
    }

    function loadFromLocalStorage(appKey) {
        if (!appKey) {
            alert("Vui lòng nhập mã ứng dụng để tải dữ liệu.");
            return;
        }
        const savedData = localStorage.getItem(`data_${appKey}`);
        if (savedData) {
            customers = JSON.parse(savedData);
            renderTable();
            alert(`Dữ liệu đã được tải cho ứng dụng: ${appKey}`);
        } else {
            alert(`Không tìm thấy dữ liệu cho ứng dụng: ${appKey}`);
        }
    }

    // Các hàm khác giữ nguyên
    window.onload = function() {
        const appKey = localStorage.getItem('currentAppKey') || 'default';
        loadFromLocalStorage(appKey);
        setupColumnResizers();
    };

    // Các hàm popup và xử lý sự kiện khác giữ nguyên
    function showSortPopup() {
        document.getElementById('sortPopup').style.display = 'block';
    }

    function closeSortPopup() {
        document.getElementById('sortPopup').style.display = 'none';
    }

    function showGuide() {
        document.getElementById('guidePopup').style.display = 'block';
    }

    function closeGuide() {
        document.getElementById('guidePopup').style.display = 'none';
    }

    function showVideoPopup() {
        document.getElementById('videoPopup').style.display = 'block';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function closeVideoPopup() {
        document.getElementById('videoPopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'none';
    }

    // Các hàm tìm kiếm và ẩn/hiện hàng giữ nguyên
    function searchCustomers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const tbody = document.querySelector('#customerTable tbody');
        
        tbody.innerHTML = '';

        customers
            .filter(product => 
                product.code.toLowerCase().includes(searchTerm) ||
                product.name.toLowerCase().includes(searchTerm) ||
                product.chainName.toLowerCase().includes(searchTerm) ||
                product.staff.toLowerCase().includes(searchTerm) ||
                (product.ordered && "đặt hàng".includes(searchTerm))
            )
            .forEach((product, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox"></td>
                    <td>${index + 1}</td>
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${product.specification}</td>
                    <td>${product.retailPrice}</td>
                    <td>${product.discount}</td>
                    <td>${product.purchasePrice}</td>
                    <td>${product.chainName}</td>
                    <td>${product.staff}</td>
                    <td>${product.ordered ? 'Có' : 'Không'}</td>
                    <td>${product.note}</td>
                    <td><button onclick="deleteCustomer(${index})">Xóa</button></td>
                `;
                if (product.ordered) {
                    tr.classList.add('ordered');
                }
                tbody.appendChild(tr);
            });
    }

    function searchByStaff() {
        const searchTerm = document.getElementById('staffSearchInput').value.toLowerCase().trim();
        const tbody = document.querySelector('#customerTable tbody');
        
        tbody.innerHTML = '';

        customers
            .filter(product => product.staff.toLowerCase().includes(searchTerm))
            .forEach((product, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox"></td>
                    <td>${index + 1}</td>
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${product.specification}</td>
                    <td>${product.retailPrice}</td>
                    <td>${product.discount}</td>
                    <td>${product.purchasePrice}</td>
                    <td>${product.chainName}</td>
                    <td>${product.staff}</td>
                    <td>${product.ordered ? 'Có' : 'Không'}</td>
                    <td>${product.note}</td>
                    <td><button onclick="deleteCustomer(${index})">Xóa</button></td>
                `;
                if (product.ordered) {
                    tr.classList.add('ordered');
                }
                tbody.appendChild(tr);
            });
    }

    let hiddenRows = [];

    function hideRows() {
        const rows = document.querySelectorAll('#customerTable tbody tr');
        hiddenRows = [];

        rows.forEach((row, index) => {
            const checkbox = row.querySelector('input[type="checkbox"]'); 
            if (checkbox && checkbox.checked) {
                hiddenRows.push(index);
                row.style.display = 'none';
            }
        });
    }

    function unhideRows() {
        const rows = document.querySelectorAll('#customerTable tbody tr');
        hiddenRows.forEach(index => {
            rows[index].style.display = '';
        });
        hiddenRows = [];
    }

    function resetData() {
        customers.forEach(product => {
            product.ordered = false;
        });
        renderTable();
        alert('Tất cả các lựa chọn đã được bỏ chọn!');
    }

    function openStaffSelection() {
        const staffNamesInput = prompt("Nhập danh sách tên nhân viên phụ trách, ngăn cách nhau bằng dấu phẩy:");
        if (staffNamesInput) {
            const staffNames = staffNamesInput.split(',').map(name => name.trim().toLowerCase());
            renderTable();
            autoSelectByStaff(staffNames);
        }
    }

    function autoSelectByStaff(staffNames) {
        const rows = document.querySelectorAll('#customerTable tbody tr');
        
        rows.forEach(row => {
            const staffCell = row.cells[9];
            const checkbox = row.querySelector('input[type="checkbox"]');
            
            if (staffCell && checkbox) {
                const staffText = staffCell.querySelector('input[type="text"]').value.trim().toLowerCase();
                if (staffNames.includes(staffText)) {
                    checkbox.checked = true;
                } else {
                    checkbox.checked = false;
                }
            }
        });
    }
</script>
</body>
</html>
