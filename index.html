<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ỨNG DỤNG QUẢN LÝ DANH MỤC THUỐC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        h1 {
            text-align: center;
            color: #e63946;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            margin-bottom: 10px;
        }
        h2 {
            text-align: center;
            color: #1d3557;
            margin-top: 5px;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            overflow: hidden;
            position: relative;
            min-width: 50px;
        }
        th {
            background-color: #457b9d;
            color: white;
            position: relative;
            user-select: none;
            font-weight: bold;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea {
            width: 100%;
            padding: 8px;
            margin: 4px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #457b9d;
            color: white;
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
            background-color: #1d3557;
        }
        button:active {
            transform: scale(0.98);
            box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
        }
        .ordered {
            background-color: #90EE90;
        }
        .medicine-ordered {
            background-color: orange;
        }
        .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: transparent;
            cursor: col-resize;
            z-index: 1000;
        }
        .resizer:hover, .resizer.active {
            background-color: #007acc;
        }
        .column-resizing {
            user-select: none;
        }
        #customerTable th:first-child,
        #customerTable td:first-child {
            width: 50px;
        }
        .guide-button {
            background-color: #4CAF50;
        }
        .guide-button:hover {
            background-color: #2e7d32;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            max-width: 90%;
            max-height: 80vh;
            background-color: white;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow: auto;
            border-radius: 8px;
        }
        .popup-content {
            margin-bottom: 20px;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 24px;
            color: #aaa;
        }
        .close-button:hover {
            color: #000;
        }
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background-color: #ccc;
            cursor: se-resize;
        }
        #declarationForm {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 800px;
            margin: 0 auto 20px;
            padding: 15px;
            background-color: #e6f2ff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #declarationForm input {
            flex: 1;
            margin-right: 10px;
        }
        textarea {
            resize: both;
            min-height: 50px;
        }
        .group-header {
            background-color: #f0f0f0 !important;
            font-weight: bold;
            padding: 10px !important;
        }
        #warningPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 500px;
            max-width: 90%;
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #ffeeba;
            padding-bottom: 10px;
        }
        .timer-display {
            background-color: #856404;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            margin: 15px 0;
            justify-content: center;
        }
        .search-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
        }
        .search-container input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
            min-width: 150px;
        }
        .stats-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #e6f2ff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #videoPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1000px;
            max-width: 90%;
            height: 600px;
            max-height: 80vh;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-radius: 10px;
            z-index: 1000;
            overflow: hidden;
            resize: both;
        }
        #videoFrame {
            width: 100%;
            height: 100%;
            border: none;
        }
        #popupOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .app-key-container {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .app-key-container input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 150px;
        }
        .export-temp-button {
            background-color: #ff9800;
        }
        .export-temp-button:hover {
            background-color: #f57c00;
        }
    </style>
</head>
<body>
    <h1>QUẢN LÝ THEO DÕI DANH MỤC THUỐC CHUỖI NHÀ THUỐC</h1>
    
    <h2>Luôn theo sát - đặt mục tiêu trong kỳ chuỗi luôn đặt hàng ít nhất > 70% danh mục họ đã vào</h2>
    
    <form id="declarationForm">
        <input type="text" id="fullName" placeholder="Họ tên" required>
        <input type="text" id="department" placeholder="Bộ phận" required>
        <input type="date" id="date" required>
    </form>
    
    <div class="action-buttons">
        <button class="guide-button" onclick="showGuide()">Hướng dẫn</button>
        <button onclick="showVideoPopup()">Hướng dẫn video</button>
        <button onclick="addNewCustomer()">Thêm mới</button>
        <input type="file" id="fileUpload" accept=".xlsx, .xls" style="display: none;">
        <button onclick="document.getElementById('fileUpload').click()">Upload Excel DSKH</button>
        <button onclick="syncData()">Đồng bộ</button>
        <input type="file" id="updateFileUpload" accept=".xlsx, .xls" style="display: none;">
        <button onclick="document.getElementById('updateFileUpload').click()">Cập nhật DSKH excel</button>
        <button onclick="reloadExcel()">Tải lại Excel</button>
        <button onclick="exportExcel()">Xuất Excel</button>
        <button class="export-temp-button" onclick="exportTempOrder()">Xuất đơn hàng tạm</button>
        <button onclick="showSortPopup()">Sắp xếp</button>
    </div>

    <div class="app-key-container">
        <label for="appKeyInput" style="font-weight: bold;">Mã ứng dụng:</label>
        <input type="text" id="appKeyInput" placeholder="VD: app1">
        <button onclick="saveToLocalStorage(document.getElementById('appKeyInput').value)">Lưu dữ liệu</button>
        <button onclick="loadFromLocalStorage(document.getElementById('appKeyInput').value)">Tải dữ liệu</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Tìm kiếm chung...">
        <button onclick="searchCustomers()">Tìm</button>
        <input type="text" id="staffSearchInput" placeholder="Tên nhân viên phụ trách...">
        <button onclick="searchByStaff()">Tìm theo NV</button>
        <button onclick="hideRows()">Ẩn hàng chọn</button>
        <button onclick="unhideRows()">Không ẩn</button>
        <button onclick="openStaffSelection()">Chọn nhân viên để ẩn</button>
        <button onclick="resetData()" style="background-color: orange;">Refresh dữ liệu</button>
        <input type="file" id="orderUpdateFile" accept=".xlsx, .xls" style="display: none;">
        <button onclick="document.getElementById('orderUpdateFile').click()">Up file đơn hàng trong kỳ</button>
    </div>

    <table id="customerTable">
        <thead>
            <tr>
                <th>Chọn</th>
                <th>STT</th>
                <th>Mã sản phẩm</th>
                <th>Tên sản phẩm</th>
                <th>Quy cách</th>
                <th>Giá bán lẻ</th>
                <th>Chiết khấu</th>
                <th>Giá mua vào</th>
                <th>Số lượng</th>
                <th>Tên chuỗi NT</th>
                <th>Nhân viên phụ trách</th>
                <th>Sản phẩm đã đặt hàng</th>
                <th>Báo cáo - ghi chú giao dịch</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="stats-container" id="stats"></div>

    <!-- Popup Hướng dẫn -->
    <div id="guidePopup" class="popup">
        <div class="popup-content">
            <h2>Hướng dẫn sử dụng</h2>
            <p style="line-height: 1.8;">
                <strong><u>Bước 1:</u></strong><br>
                Cấp quản lý sẽ quản lý dữ liệu để up lên ứng dụng này từ việc chọn kỳ từ ngày 1-1-2023 đến nay, xuất file excel từ ERP-DANH SÁCH KHÁCH HÀNG.<br>
                Sau đó, file excel này sẽ được bỏ các tiêu đề phụ chỉ chừa lại dữ liệu theo cấu trúc khung của ứng dụng này...
				Chuẩn bị file excel dữ liệu từ ERP xuất file, em phải bỏ wrap text, merge hết toàn bộ bảng- sau đó chỉnh nội dung tiêu đề như dưới:<br>
				" STT|	Mã|	tên|	Sản lượng bán	|Sản lượng tặng	Sản lượng| thu hồi|	Tổng sản lượng"; lưu tên file này rồi upload nhé

            </p>
        </div>
        <span class="close-button" onclick="closeGuide()">&times;</span>
        <div class="resize-handle"></div>
    </div>

    <!-- Popup Sắp xếp -->
    <div id="sortPopup" class="popup">
        <div class="popup-content">
            <h3>Sắp xếp theo</h3>
            <select id="sortField">
                <option value="1">Mã</option>
                <option value="6">Khu vực</option>
                <option value="8">Nhân viên phụ trách</option>
            </select>
            <button onclick="groupAndSortData()">Nhóm và sắp xếp</button>
            <button onclick="closeSortPopup()">Đóng</button>
        </div>
    </div>

    <!-- Warning Popup -->
    <div id="warningPopup">
        <div class="popup-header">
            <h3>Cảnh báo!</h3>
            <div class="timer-display">
                Thời gian hiển thị: <span id="countdown">8</span>s
            </div>
            <span class="close-button">&times;</span>
        </div>
        <div class="popup-content">
            <p>Số khách hàng do em quản lý đặt hàng còn rất thấp- hãy tập trung hết mình tương tác...</p>
        </div>
        <div class="resize-handle"></div>
    </div>

    <div id="videoPopup">
        <iframe id="videoFrame" src="https://www.youtube.com/embed/iK-iDa32Bh8"></iframe>
        <button onclick="closeVideoPopup()" style="position:absolute; top:10px; right:10px; background:red; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-size:18px;">&times;</button>
    </div>
    <div id="popupOverlay" onclick="closeVideoPopup()"></div>

<script>
    // Khai báo biến toàn cục
    let customers = [];
    let currentCustomerCode = 1;
    let isResizing = false;
    let currentResizer = null;
    let startX, startWidth;

    // Các hàm xử lý khách hàng
    function addNewCustomer() {
        const newCustomer = {
            code: `SP${currentCustomerCode++}`,
            name: '',
            specification: '',
            retailPrice: '',
            discount: '',
            purchasePrice: '',
            quantity: '',
            chainName: '',
            staff: '',
            ordered: false,
            note: ''
        };
        customers.push(newCustomer);
        renderTable();
    }

    function renderTable() {
        const tbody = document.querySelector('#customerTable tbody');
        tbody.innerHTML = '';
        customers.forEach((customer, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox"></td>
                <td>${index + 1}</td>
                <td><input type="text" value="${customer.code || ''}" onchange="updateCustomer(${index}, 'code', this.value)"></td>
                <td><input type="text" value="${customer.name || ''}" onchange="updateCustomer(${index}, 'name', this.value)"></td>
                <td><input type="text" value="${customer.specification || ''}" onchange="updateCustomer(${index}, 'specification', this.value)"></td>
                <td><input type="text" value="${customer.retailPrice || ''}" onchange="updateCustomer(${index}, 'retailPrice', this.value)"></td>
                <td><input type="text" value="${customer.discount || ''}" onchange="updateCustomer(${index}, 'discount', this.value)"></td>
                <td><input type="text" value="${customer.purchasePrice || ''}" onchange="updateCustomer(${index}, 'purchasePrice', this.value)"></td>
                <td><input type="number" min="0" value="${customer.quantity || ''}" onchange="updateCustomer(${index}, 'quantity', this.value)"></td>
                <td><input type="text" value="${customer.chainName || ''}" onchange="updateCustomer(${index}, 'chainName', this.value)"></td>
                <td><input type="text" value="${customer.staff || ''}" onchange="updateCustomer(${index}, 'staff', this.value)"></td>
                <td><input type="checkbox" ${customer.ordered ? 'checked' : ''} onchange="updateCustomer(${index}, 'ordered', this.checked)"></td>
                <td><textarea onchange="updateCustomer(${index}, 'note', this.value)">${customer.note || ''}</textarea></td>
                <td><button onclick="deleteCustomer(${index})">Xóa</button></td>
            `;
            if (customer.ordered) {
                tr.classList.add('ordered');
            }
            tbody.appendChild(tr);
        });
        updateStats();
        setupColumnResizers();
    }

    function updateCustomer(index, field, value) {
        customers[index][field] = value;
        if (field === 'ordered') {
            renderTable();
        } else {
            updateStats();
        }
    }

    function deleteCustomer(index) {
        if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
            customers.splice(index, 1);
            renderTable();
        }
    }

    function updateStats() {
        const declaredStaff = document.getElementById('fullName').value.trim().toLowerCase();

        if (!declaredStaff) {
            document.getElementById('stats').innerHTML = `
                <span style="color: red">Vui lòng khai báo họ tên để tính toán số liệu</span>
            `;
            return;
        }

        // Lọc sản phẩm do nhân viên phụ trách khai báo
        const staffProducts = customers.filter(c => c.staff.toLowerCase().trim() === declaredStaff);
        const staffTotal = staffProducts.length;

        // Số sản phẩm đã đặt hàng
        const staffOrdered = staffProducts.filter(c => c.ordered).length;

        // Tỷ lệ đặt hàng
        const staffRate = staffTotal > 0 ? ((staffOrdered / staffTotal) * 100).toFixed(2) : 0;

        // Hiển thị kết quả
        document.getElementById('stats').innerHTML = `
            <h3>Thống kê cho ${declaredStaff}:</h3>
            Tổng số sản phẩm: ${staffTotal}<br>
            Số sản phẩm đã đặt hàng: ${staffOrdered}<br>
            Tỉ lệ đặt hàng: ${staffRate}%<br>
            <progress value="${staffRate}" max="100" style="width: 100%; height: 20px;"></progress>
        `;

        // Hiển thị cảnh báo nếu tỷ lệ đặt hàng thấp
        if (staffTotal > 0 && staffRate < 70) {
            showWarningPopup();
        }
    }

    // Hàm thiết lập resizer cho các cột
    function setupColumnResizers() {
        // Xóa các resizer cũ nếu có
        document.querySelectorAll('.resizer').forEach(el => el.remove());
        
        // Thêm resizer cho mỗi cột trong thead
        const headers = document.querySelectorAll('#customerTable th');
        headers.forEach((header, index) => {
            const resizer = document.createElement('div');
            resizer.classList.add('resizer');
            header.appendChild(resizer);
            
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startResize(e, header, index);
            });
        });
    }

    function startResize(e, header, columnIndex) {
        isResizing = true;
        currentResizer = header;
        startX = e.clientX;
        startWidth = header.offsetWidth;
        
        document.addEventListener('mousemove', resizeColumn);
        document.addEventListener('mouseup', stopResize);
        
        document.body.classList.add('column-resizing');
        header.classList.add('active');
    }

    function resizeColumn(e) {
        if (!isResizing) return;
        
        const width = startWidth + (e.clientX - startX);
        if (width > 50) {
            currentResizer.style.width = `${width}px`;
            
            // Áp dụng cùng chiều rộng cho tất cả các ô trong cột
            const columnIndex = Array.from(currentResizer.parentNode.children).indexOf(currentResizer);
            const allRows = document.querySelectorAll('#customerTable tr');
            
            allRows.forEach(row => {
                const cell = row.children[columnIndex];
                if (cell) {
                    cell.style.width = `${width}px`;
                }
            });
        }
    }

    function stopResize() {
        isResizing = false;
        document.removeEventListener('mousemove', resizeColumn);
        document.removeEventListener('mouseup', stopResize);
        
        document.body.classList.remove('column-resizing');
        if (currentResizer) {
            currentResizer.classList.remove('active');
        }
    }

    // Hàm xử lý Excel
    function uploadExcel() {
        const fileInput = document.getElementById('fileUpload');
        const file = fileInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: false,
                        defval: "",
                        header: ["STT", "Mã sản phẩm", "Tên sản phẩm", "Quy cách", "Giá bán lẻ", "Chiết khấu", "Giá mua vào", "Số lượng", "Tên chuỗi NT", "Nhân viên phụ trách", "Đã đặt hàng", "Ghi chú"]
                    });

                    // Cập nhật danh sách sản phẩm
                    customers = jsonData.map((row, index) => {
                        return {
                            code: row['Mã sản phẩm'] || `SP${index + 1}`,
                            name: row['Tên sản phẩm'] || '',
                            specification: row['Quy cách'] || '',
                            retailPrice: row['Giá bán lẻ'] || '',
                            discount: row['Chiết khấu'] || '',
                            purchasePrice: row['Giá mua vào'] || '',
                            quantity: row['Số lượng'] || '',
                            chainName: row['Tên chuỗi NT'] || '',
                            staff: row['Nhân viên phụ trách'] || '',
                            ordered: row['Đã đặt hàng'] === 'Có' || row['Đã đặt hàng'] === 'TRUE',
                            note: row['Ghi chú'] || ''
                        };
                    });

                    // Đảm bảo mã sản phẩm là duy nhất
                    currentCustomerCode = Math.max(...customers.map(c => parseInt(c.code.replace('SP', '')) || 0)) + 1;

                    renderTable();
                    alert('Đã tải lên và xử lý file Excel thành công!');
                } catch (error) {
                    console.error('Lỗi khi xử lý file Excel:', error);
                    alert('Có lỗi xảy ra khi xử lý file Excel. Vui lòng kiểm tra lại.');
                }
            };
            reader.readAsArrayBuffer(file);
        } else {
            alert('Vui lòng chọn một file Excel để tải lên.');
        }
    }

    // Hàm cập nhật đơn hàng từ file Excel - ĐÃ SỬA LỖI
    function updateOrderData() {
        const fileInput = document.getElementById('orderUpdateFile');
        const file = fileInput.files[0];

        if (!file) {
            alert('Vui lòng chọn một file Excel Đơn Hàng để cập nhật đơn hàng.');
            return;
        }

        const reader = new FileReader();

        reader.onload = function (e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];

                // Đọc dữ liệu từ file Excel đơn hàng
                const orderData = XLSX.utils.sheet_to_json(worksheet, {
                    raw: false,
                    defval: "",
                    header: ["STT", "Mã SP", "Tên sản phẩm", "Số lượng", "Đơn giá", "Thành tiền", "Ngày đặt", "Tên chuỗi NT", "Ghi chú"]
                });

                let updatesCount = 0;

                orderData.forEach(row => {
                    const productCode = row["Mã SP"]?.toString().trim();
                    const productName = row["Tên sản phẩm"]?.toString().trim();

                    if (!productCode && !productName) {
                        console.warn(`Bỏ qua dòng thiếu thông tin sản phẩm: ${JSON.stringify(row)}`);
                        return;
                    }

                    // Tìm sản phẩm trong danh sách ứng dụng
                    const productIndex = customers.findIndex(product => 
                        (productCode && product.code?.toString().trim() === productCode) ||
                        (productName && product.name?.toString().trim().toLowerCase() === productName.toLowerCase())
                    );

                    if (productIndex !== -1) {
                        // Tick cột "Sản phẩm đã đặt hàng"
                        customers[productIndex].ordered = true;
                        updatesCount++;
                        console.log(`Tick đặt hàng cho sản phẩm: ${productCode || productName}`);
                    } else {
                        console.warn(`Không tìm thấy sản phẩm: ${productCode || productName}`);
                    }
                });

                // Cập nhật lại giao diện bảng
                renderTable();
                alert(`Cập nhật đơn hàng thành công! Số lượng sản phẩm được cập nhật: ${updatesCount}`);
            } catch (error) {
                console.error('Lỗi khi xử lý file Excel:', error);
                alert('Có lỗi xảy ra khi xử lý file Excel. Vui lòng kiểm tra lại.');
            }
        };

        reader.readAsArrayBuffer(file);
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(customers.map(c => ({
            STT: c.code,
            "Mã sản phẩm": c.code,
            "Tên sản phẩm": c.name,
            "Quy cách": c.specification,
            "Giá bán lẻ": c.retailPrice,
            "Chiết khấu": c.discount,
            "Giá mua vào": c.purchasePrice,
            "Số lượng": c.quantity,
            "Tên chuỗi NT": c.chainName,
            "Nhân viên phụ trách": c.staff,
            "Đã đặt hàng": c.ordered ? "Có" : "Không",
            "Ghi chú": c.note
        })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Products");

        const fullName = document.getElementById('fullName').value || 'unknown';
        const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
        const fileName = `${fullName}-dulieusanpham-${date}.xlsx`;

        XLSX.writeFile(wb, fileName);
    }

    // Hàm xuất đơn hàng tạm
    function exportTempOrder() {
        // Lấy các hàng được chọn
        const selectedRows = [];
        const checkboxes = document.querySelectorAll('#customerTable tbody tr input[type="checkbox"]');
        
        checkboxes.forEach((checkbox, index) => {
            if (checkbox.checked) {
                selectedRows.push(customers[index]);
            }
        });
        
        if (selectedRows.length === 0) {
            alert('Vui lòng chọn ít nhất một sản phẩm để xuất đơn hàng tạm.');
            return;
        }
        
        // Tạo dữ liệu Excel với tiêu đề
        const dataForExport = [
            ["BẢNG ĐƠN HÀNG TẠM TÍNH SẢN LƯỢNG"],
            [""], // Dòng trống
            ["STT", "Mã sản phẩm", "Tên sản phẩm", "Quy cách", "Giá bán lẻ", "Chiết khấu", "Giá mua vào", "Số lượng", "Tên chuỗi NT", "Nhân viên phụ trách", "Đã đặt hàng", "Ghi chú"]
        ];
        
        // Thêm dữ liệu sản phẩm
        selectedRows.forEach((c, index) => {
            dataForExport.push([
                index + 1,
                c.code,
                c.name,
                c.specification,
                c.retailPrice,
                c.discount,
                c.purchasePrice,
                c.quantity,
                c.chainName,
                c.staff,
                c.ordered ? "Có" : "Không",
                c.note
            ]);
        });
        
        // Tạo worksheet từ dữ liệu
        const ws = XLSX.utils.aoa_to_sheet(dataForExport);
        
        // Thiết lập độ rộng cột
        const colWidths = [
            {wch: 5},  // STT
            {wch: 15}, // Mã sản phẩm
            {wch: 30}, // Tên sản phẩm
            {wch: 20}, // Quy cách
            {wch: 12}, // Giá bán lẻ
            {wch: 12}, // Chiết khấu
            {wch: 12}, // Giá mua vào
            {wch: 10}, // Số lượng
            {wch: 20}, // Tên chuỗi NT
            {wch: 20}, // Nhân viên phụ trách
            {wch: 15}, // Đã đặt hàng
            {wch: 30}  // Ghi chú
        ];
        ws['!cols'] = colWidths;
        
        // Merge ô tiêu đề
        if (!ws['!merges']) ws['!merges'] = [];
        ws['!merges'].push({s: {r: 0, c: 0}, e: {r: 0, c: 11}}); // Merge từ cột A đến L cho tiêu đề
        
        // Tạo workbook và thêm sheet
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Đơn hàng tạm");
        
        // Xuất file
        const fullName = document.getElementById('fullName').value || 'unknown';
        const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
        const fileName = `${fullName}-don-hang-tam-${date}.xlsx`;
        
        XLSX.writeFile(wb, fileName);
        alert(`Đã xuất file đơn hàng tạm với ${selectedRows.length} sản phẩm.`);
    }

    // Các hàm khác
    function syncData() {
        renderTable();
        alert("Đã đồng bộ dữ liệu.");
    }

    function reloadExcel() {
        renderTable();
        alert("Đã tải lại dữ liệu Excel.");
    }

    function saveToLocalStorage(appKey) {
        if (!appKey) {
            alert("Vui lòng nhập mã ứng dụng để lưu dữ liệu.");
            return;
        }
        localStorage.setItem(`data_${appKey}`, JSON.stringify(customers));
        alert(`Dữ liệu đã được lưu cho ứng dụng: ${appKey}`);
    }

    function loadFromLocalStorage(appKey) {
        if (!appKey) {
            alert("Vui lòng nhập mã ứng dụng để tải dữ liệu.");
            return;
        }
        const savedData = localStorage.getItem(`data_${appKey}`);
        if (savedData) {
            customers = JSON.parse(savedData);
            renderTable();
            alert(`Dữ liệu đã được tải cho ứng dụng: ${appKey}`);
        } else {
            alert(`Không tìm thấy dữ liệu cho ứng dụng: ${appKey}`);
        }
    }

    // Các hàm popup và xử lý sự kiện
    window.onload = function() {
        const appKey = localStorage.getItem('currentAppKey') || 'default';
        loadFromLocalStorage(appKey);
        setupColumnResizers();
        
        // Thiết lập sự kiện cho file input
        document.getElementById('orderUpdateFile').addEventListener('change', updateOrderData);
        document.getElementById('fileUpload').addEventListener('change', uploadExcel);
        document.getElementById('updateFileUpload').addEventListener('change', uploadExcel);
    };

    function showSortPopup() {
        document.getElementById('sortPopup').style.display = 'block';
    }

    function closeSortPopup() {
        document.getElementById('sortPopup').style.display = 'none';
    }

    function showGuide() {
        document.getElementById('guidePopup').style.display = 'block';
    }

    function closeGuide() {
        document.getElementById('guidePopup').style.display = 'none';
    }

    function showVideoPopup() {
        document.getElementById('videoPopup').style.display = 'block';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function closeVideoPopup() {
        document.getElementById('videoPopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'none';
    }

    function showWarningPopup() {
        const popup = document.getElementById('warningPopup');
        popup.style.display = 'block';
        
        let countdown = 8;
        const countdownElement = document.getElementById('countdown');
        countdownElement.textContent = countdown;
        
        const timer = setInterval(() => {
            countdown--;
            countdownElement.textContent = countdown;
            
            if (countdown <= 0) {
                clearInterval(timer);
                popup.style.display = 'none';
            }
        }, 1000);
        
        // Đóng popup khi click vào nút đóng
        popup.querySelector('.close-button').onclick = function() {
            clearInterval(timer);
            popup.style.display = 'none';
        };
    }

    function resetData() {
        if (confirm('Bạn có chắc chắn muốn làm mới dữ liệu? Tất cả dữ liệu chưa lưu sẽ bị mất.')) {
            customers = [];
            currentCustomerCode = 1;
            renderTable();
            alert('Dữ liệu đã được làm mới.');
        }
    }

    function searchCustomers() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#customerTable tbody tr');
        
        rows.forEach((row, index) => {
            const rowData = customers[index];
            const match = Object.values(rowData).some(value => 
                value && value.toString().toLowerCase().includes(searchText)
            );
            
            row.style.display = match ? '' : 'none';
        });
    }

    function searchByStaff() {
        const staffName = document.getElementById('staffSearchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#customerTable tbody tr');
        
        rows.forEach((row, index) => {
            const staff = customers[index].staff.toLowerCase();
            row.style.display = staff.includes(staffName) ? '' : 'none';
        });
    }

    function hideRows() {
        const rows = document.querySelectorAll('#customerTable tbody tr');
        rows.forEach((row, index) => {
            if (customers[index].ordered) {
                row.style.display = 'none';
            }
        });
    }

    function unhideRows() {
        const rows = document.querySelectorAll('#customerTable tbody tr');
        rows.forEach(row => {
            row.style.display = '';
        });
    }

    function openStaffSelection() {
        const staffList = [...new Set(customers.map(c => c.staff).filter(Boolean))];
        const selectedStaff = prompt(`Danh sách nhân viên:\n${staffList.join('\n')}\n\nNhập tên nhân viên để ẩn:`);
        
        if (selectedStaff) {
            const rows = document.querySelectorAll('#customerTable tbody tr');
            rows.forEach((row, index) => {
                if (customers[index].staff === selectedStaff) {
                    row.style.display = 'none';
                }
            });
        }
    }

    function groupAndSortData() {
        const sortField = document.getElementById('sortField').value;
        customers.sort((a, b) => {
            const valA = Object.values(a)[sortField] || '';
            const valB = Object.values(b)[sortField] || '';
            return valA.toString().localeCompare(valB.toString());
        });
        renderTable();
        closeSortPopup();
    }
</script>
</body>
</html>
